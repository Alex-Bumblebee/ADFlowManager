<ui:FluentWindow
    x:Class="ADFlowManager.UI.Views.Windows.UserDetailsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:local="clr-namespace:ADFlowManager.UI.Views.Windows"
    xmlns:ext="clr-namespace:ADFlowManager.UI.Extensions"
    Title="{Binding ViewModel.WindowTitle}"
    Width="1000"
    Height="700"
    d:DesignHeight="700"
    d:DesignWidth="1000"
    ExtendsContentIntoTitleBar="True"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    WindowBackdropType="Mica"
    WindowCornerPreference="Round"
    WindowStartupLocation="CenterOwner"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- === CONTENT === -->
        <Grid Grid.Row="1" Margin="24,0,24,16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- ============================================ -->
            <!-- HEADER : Avatar + Info + Edit Switch         -->
            <!-- ============================================ -->
            <Border
                Grid.Row="0"
                Background="#1E1E1E"
                BorderBrush="#3F3F46"
                BorderThickness="1"
                CornerRadius="8"
                Padding="16,12"
                Margin="0,0,0,12">

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Avatar -->
                    <Border
                        Grid.Column="0"
                        Width="52"
                        Height="52"
                        Margin="0,0,16,0"
                        VerticalAlignment="Center"
                        Background="#3B2D5E"
                        CornerRadius="26">
                        <TextBlock
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            FontSize="18"
                            FontWeight="Bold"
                            Foreground="#8B5CF6"
                            Text="{Binding ViewModel.Initials}" />
                    </Border>

                    <!-- Name + UserName + Status -->
                    <StackPanel
                        Grid.Column="1"
                        VerticalAlignment="Center">
                        <TextBlock
                            FontSize="18"
                            FontWeight="Bold"
                            Foreground="#F5F5F5"
                            Text="{Binding ViewModel.DisplayName}" />
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <TextBlock
                                FontSize="13"
                                Foreground="#A1A1AA"
                                Text="{Binding ViewModel.UserName}"
                                Margin="0,0,12,0" />
                            <!-- Status badge -->
                            <Border
                                VerticalAlignment="Center"
                                CornerRadius="4"
                                Padding="8,2">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#1A10B981" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.IsEnabled}" Value="False">
                                                <Setter Property="Background" Value="#1AEF4444" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock
                                    FontSize="11"
                                    FontWeight="SemiBold"
                                    Text="{Binding ViewModel.IsEnabled, Converter={StaticResource BoolToStatusTextConverter}}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="#10B981" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ViewModel.IsEnabled}" Value="False">
                                                    <Setter Property="Foreground" Value="#EF4444" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Border>
                        </StackPanel>
                    </StackPanel>

                    <!-- Edit Switch -->
                    <StackPanel
                        Grid.Column="2"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            FontSize="13"
                            VerticalAlignment="Center"
                            Margin="0,0,12,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{ext:Localized UserDetails_ViewMode}" />
                                    <Setter Property="Foreground" Value="#A1A1AA" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ViewModel.IsEditMode}" Value="True">
                                            <Setter Property="Text" Value="{ext:Localized UserDetails_EditMode}" />
                                            <Setter Property="Foreground" Value="#8B5CF6" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <ui:ToggleSwitch
                            IsChecked="{Binding ViewModel.IsEditMode}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ============================================ -->
            <!-- TABS                                          -->
            <!-- ============================================ -->
            <TabControl
                Grid.Row="1"
                SelectedIndex="{Binding ViewModel.SelectedTabIndex, Mode=TwoWay}"
                Background="Transparent"
                BorderThickness="0"
                Padding="0">

                <!-- ====== Tab 1 : Général ====== -->
                <TabItem Header="{ext:Localized UserDetails_TabGeneral}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,16,0,0">

                            <!-- Row: Prénom + Nom -->
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{ext:Localized UserDetails_FirstName}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.FirstName, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="{ext:Localized UserDetails_LastName}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.LastName, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>
                            </Grid>

                            <!-- Row: DisplayName + UserName -->
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{ext:Localized UserDetails_DisplayName}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.DisplayName}"
                                        IsReadOnly="True"
                                        Background="#1E1E1E"
                                        Foreground="#A1A1AA"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="{ext:Localized UserDetails_Login}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.UserName}"
                                        IsReadOnly="True"
                                        Background="#1E1E1E"
                                        Foreground="#A1A1AA"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>
                            </Grid>

                            <!-- Description -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_Description}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <ui:TextBox
                                    Text="{Binding ViewModel.Description, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                    Background="#2D2D30"
                                    Foreground="#F5F5F5"
                                    BorderBrush="#3F3F46"
                                    Height="40" />
                            </StackPanel>

                            <!-- Statut du compte -->
                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_AccountStatus}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <Border
                                    Background="#2D2D30"
                                    BorderBrush="#3F3F46"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="12,0"
                                    Height="40"
                                    HorizontalAlignment="Left">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <Ellipse Width="8" Height="8" Margin="0,0,8,0">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#10B981" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ViewModel.IsEnabled}" Value="False">
                                                            <Setter Property="Fill" Value="#EF4444" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                        <TextBlock
                                            FontSize="13"
                                            VerticalAlignment="Center"
                                            Text="{Binding ViewModel.IsEnabled, Converter={StaticResource BoolToStatusTextConverter}}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#10B981" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ViewModel.IsEnabled}" Value="False">
                                                            <Setter Property="Foreground" Value="#EF4444" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- ====== Tab 2 : Contact ====== -->
                <TabItem Header="{ext:Localized UserDetails_TabContact}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,16,0,0">

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_Email}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <ui:TextBox
                                    Text="{Binding ViewModel.Email, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                    Background="#2D2D30"
                                    Foreground="#F5F5F5"
                                    BorderBrush="#3F3F46"
                                    Height="40" />
                            </StackPanel>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_Phone}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <ui:TextBox
                                    Text="{Binding ViewModel.Phone, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                    Background="#2D2D30"
                                    Foreground="#F5F5F5"
                                    BorderBrush="#3F3F46"
                                    Height="40" />
                            </StackPanel>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_Mobile}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <ui:TextBox
                                    Text="{Binding ViewModel.Mobile, UpdateSourceTrigger=PropertyChanged}"
                                    IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                    Background="#2D2D30"
                                    Foreground="#F5F5F5"
                                    BorderBrush="#3F3F46"
                                    Height="40" />
                            </StackPanel>

                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- ====== Tab 3 : Organisation ====== -->
                <TabItem Header="{ext:Localized UserDetails_TabOrganization}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,16,0,0">

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="{ext:Localized UserDetails_DistinguishedName}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                <ui:TextBox
                                    Text="{Binding ViewModel.DistinguishedName}"
                                    IsReadOnly="True"
                                    Background="#1E1E1E"
                                    Foreground="#A1A1AA"
                                    BorderBrush="#3F3F46"
                                    Height="40" />
                            </StackPanel>

                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{ext:Localized UserDetails_JobTitle}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.JobTitle, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="{ext:Localized UserDetails_Department}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.Department, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>
                            </Grid>

                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{ext:Localized UserDetails_Company}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.Company, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>

                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="{ext:Localized UserDetails_Office}" FontSize="12" Foreground="#A1A1AA" Margin="0,0,0,4" />
                                    <ui:TextBox
                                        Text="{Binding ViewModel.Office, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding ViewModel.IsEditMode, Converter={StaticResource InverseBoolConverter}}"
                                        Background="#2D2D30"
                                        Foreground="#F5F5F5"
                                        BorderBrush="#3F3F46"
                                        Height="40" />
                                </StackPanel>
                            </Grid>

                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- ====== Tab 4 : Groupes ====== -->
                <TabItem>
                    <TabItem.Header>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{ext:Localized UserDetails_TabGroups}" VerticalAlignment="Center" />
                            <Border
                                Background="#3B2D5E"
                                CornerRadius="8"
                                Padding="6,2"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center">
                                <TextBlock
                                    Text="{Binding ViewModel.GroupCount}"
                                    FontSize="11"
                                    Foreground="#8B5CF6"
                                    FontWeight="Bold" />
                            </Border>
                        </StackPanel>
                    </TabItem.Header>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- Barre d'ajout de groupe (visible en mode édition) -->
                        <Border
                            Grid.Row="0"
                            Margin="0,12,0,8"
                            Visibility="{Binding ViewModel.IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <ui:TextBox
                                    x:Name="GroupSearchTextBox"
                                    Grid.Column="0"
                                    PlaceholderText="{ext:Localized UserDetails_SearchGroup}"
                                    Text="{Binding ViewModel.GroupSearchText, UpdateSourceTrigger=PropertyChanged}"
                                    Background="#2D2D30"
                                    Foreground="#F5F5F5"
                                    BorderBrush="#3F3F46"
                                    Height="38"
                                    FontSize="13"
                                    Margin="0,0,8,0">
                                    <ui:TextBox.Icon>
                                        <ui:SymbolIcon Symbol="Search24" Foreground="#8B5CF6" />
                                    </ui:TextBox.Icon>
                                </ui:TextBox>

                                <ui:Button
                                    Grid.Column="1"
                                    Content="{ext:Localized UserDetails_AddGroup}"
                                    Appearance="Primary"
                                    Command="{Binding ViewModel.AddSelectedGroupCommand}"
                                    Height="38"
                                    Padding="16,0">
                                    <ui:Button.Icon>
                                        <ui:SymbolIcon Symbol="Add24" />
                                    </ui:Button.Icon>
                                </ui:Button>
                            </Grid>
                        </Border>

                        <!-- Liste déroulante résultats recherche -->
                        <Popup
                            IsOpen="{Binding ViewModel.IsGroupSearchOpen}"
                            PlacementTarget="{Binding ElementName=GroupSearchTextBox}"
                            Placement="Bottom"
                            StaysOpen="False"
                            AllowsTransparency="True"
                            PopupAnimation="Fade"
                            HorizontalOffset="0">
                            <Border
                                Background="#252525"
                                BorderBrush="#3F3F46"
                                BorderThickness="1"
                                CornerRadius="6"
                                MaxHeight="200"
                                MinWidth="400">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding ViewModel.FilteredAvailableGroups}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border
                                                    Background="Transparent"
                                                    Padding="10,6"
                                                    Cursor="Hand"
                                                    MouseLeftButtonDown="GroupSearchResult_Click">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Background" Value="#3B2D5E" />
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <StackPanel Orientation="Horizontal">
                                                        <ui:SymbolIcon
                                                            Symbol="PeopleTeam16"
                                                            FontSize="14"
                                                            Foreground="#8B5CF6"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock
                                                            Text="{Binding GroupName}"
                                                            FontSize="13"
                                                            Foreground="#F5F5F5" />
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </Popup>

                        <!-- Liste des groupes actuels -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <ItemsControl
                                ItemsSource="{Binding ViewModel.UserGroups}"
                                Margin="0,4,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Background="#2D2D30"
                                            CornerRadius="6"
                                            Padding="12,8"
                                            Margin="0,0,0,6">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <ui:SymbolIcon
                                                    Grid.Column="0"
                                                    Symbol="PeopleTeam16"
                                                    FontSize="16"
                                                    Foreground="#8B5CF6"
                                                    Margin="0,0,10,0"
                                                    VerticalAlignment="Center" />

                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock
                                                        Text="{Binding GroupName}"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Foreground="#F5F5F5" />
                                                    <TextBlock
                                                        Text="{Binding Description}"
                                                        FontSize="11"
                                                        Foreground="#71717A" />
                                                </StackPanel>

                                                <!-- Remove button (visible uniquement en mode édition) -->
                                                <ui:Button
                                                    Grid.Column="2"
                                                    Appearance="Secondary"
                                                    VerticalAlignment="Center"
                                                    Width="32"
                                                    Height="32"
                                                    Padding="0"
                                                    ToolTip="{ext:Localized UserDetails_RemoveGroup}"
                                                    Visibility="{Binding DataContext.ViewModel.IsEditMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibilityConverter}}"
                                                    Command="{Binding DataContext.ViewModel.RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}">
                                                    <ui:Button.Icon>
                                                        <ui:SymbolIcon Symbol="Dismiss24" FontSize="14" />
                                                    </ui:Button.Icon>
                                                </ui:Button>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </TabItem>

                <!-- ====== Tab 5 : Historique ====== -->
                <TabItem Header="{ext:Localized UserDetails_TabHistory}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl
                            ItemsSource="{Binding ViewModel.AuditEntries}"
                            Margin="0,16,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Background="#2D2D30"
                                        CornerRadius="6"
                                        Padding="12,10"
                                        Margin="0,0,0,6">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <Border
                                                Grid.Column="0"
                                                Width="36"
                                                Height="36"
                                                CornerRadius="18"
                                                Background="#3B2D5E"
                                                Margin="0,0,12,0"
                                                VerticalAlignment="Center">
                                                <ui:SymbolIcon
                                                    Symbol="History24"
                                                    FontSize="16"
                                                    Foreground="#8B5CF6"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center" />
                                            </Border>

                                            <StackPanel
                                                Grid.Column="1"
                                                VerticalAlignment="Center">
                                                <TextBlock
                                                    Text="{Binding Action}"
                                                    FontSize="13"
                                                    FontWeight="SemiBold"
                                                    Foreground="#F5F5F5" />
                                                <TextBlock
                                                    Text="{Binding Details}"
                                                    FontSize="11"
                                                    Foreground="#71717A" />
                                            </StackPanel>

                                            <TextBlock
                                                Grid.Column="2"
                                                Text="{Binding Date, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}"
                                                FontSize="11"
                                                Foreground="#71717A"
                                                VerticalAlignment="Center" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </TabItem>

            </TabControl>

            <!-- ============================================ -->
            <!-- FOOTER : Actions + Save/Close                -->
            <!-- ============================================ -->
            <Border
                Grid.Row="2"
                BorderBrush="#3F3F46"
                BorderThickness="0,1,0,0"
                Padding="0,12,0,0"
                Margin="0,8,0,0">

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Left: Action buttons -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <ui:Button
                            Content="{ext:Localized UserDetails_ResetPassword}"
                            Appearance="Secondary"
                            Click="ResetPasswordButton_Click"
                            Height="36"
                            Margin="0,0,8,0"
                            Padding="16,0">
                            <ui:Button.Icon>
                                <ui:SymbolIcon Symbol="Key24" />
                            </ui:Button.Icon>
                        </ui:Button>

                        <ui:Button
                            Appearance="Secondary"
                            Command="{Binding ViewModel.ToggleAccountCommand}"
                            Height="36"
                            Padding="16,0"
                            Visibility="{Binding ViewModel.IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ui:Button.Content>
                                <TextBlock VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="{ext:Localized UserDetails_DisableAccount}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ViewModel.IsEnabled}" Value="False">
                                                    <Setter Property="Text" Value="{ext:Localized UserDetails_EnableAccount}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </ui:Button.Content>
                            <ui:Button.Icon>
                                <ui:SymbolIcon Symbol="PersonProhibited24" />
                            </ui:Button.Icon>
                        </ui:Button>
                    </StackPanel>

                    <!-- Right: Save + Close -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <ui:Button
                            Content="{ext:Localized UserDetails_Save}"
                            Appearance="Primary"
                            Click="SaveButton_Click"
                            Height="36"
                            Margin="0,0,8,0"
                            Padding="24,0"
                            Visibility="{Binding ViewModel.IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ui:Button.Icon>
                                <ui:SymbolIcon Symbol="Save24" />
                            </ui:Button.Icon>
                        </ui:Button>

                        <ui:Button
                            Content="{ext:Localized Common_Close}"
                            Appearance="Secondary"
                            Click="CloseButton_Click"
                            Height="36"
                            Padding="24,0" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- === TITLEBAR === -->
        <ui:TitleBar
            x:Name="TitleBar"
            Title="{Binding ViewModel.WindowTitle}"
            Grid.Row="0"
            CloseWindowByDoubleClickOnIcon="True">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="pack://application:,,,/Assets/logo.png" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>
    </Grid>
</ui:FluentWindow>
